// prisma/schema.prisma
// Configuration pour Neon Postgres (via Vercel)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTHENTIFICATION & UTILISATEURS
// ============================================

enum Role {
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  role         Role
  firstName    String
  lastName     String
  phone        String?
  address      String?
  city         String?
  postalCode   String?
  isActive     Boolean   @default(true)
  lastLogin    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations selon le rÃ´le
  teacherProfile TeacherProfile?
  studentProfile StudentProfile?

  // Relations communes
  sentMessages   Message[]       @relation("SentMessages")
  calendarEvents CalendarEvent[]
  aiChats        AIChat[]
  notifications  Notification[]
  messageReadStatus MessageReadStatus[]

  // ðŸ†• Phase 7.8 - Ã‰quipes et Assignations
  teamMemberships       TeamMember[]
  teacherAssignments    CourseAssignment[] @relation("TeacherCourseAssignments")
  studentAssignments    CourseAssignment[] @relation("StudentCourseAssignments")
  studentProgress       StudentProgress[]

  // ðŸ†• Phase 7bis - Scores agrÃ©gÃ©s
  studentScores         StudentScore[]     @relation("StudentScores")
}

model TeacherProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations many-to-many
  subjects Subject[] @relation("TeacherSubjects")
  classes  Class[]   @relation("TeacherClasses")

  // Contenus crÃ©Ã©s
  courses Course[]
}

model StudentProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation(fields: [classId], references: [id])

  parentEmail String?

  // Relations
  subjects       Subject[]       @relation("StudentSubjects")
  grades         Grade[]
  progressions   Progression[]
  labProjects    LabProject[]
  knowledgeBases KnowledgeBase[] @relation("StudentKnowledge")
}

// ============================================
// ORGANISATION SCOLAIRE
// ============================================

model Subject {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teachers       TeacherProfile[] @relation("TeacherSubjects")
  students       StudentProfile[] @relation("StudentSubjects")
  courses        Course[]
  conversations  Conversation[]
  knowledgeBases KnowledgeBase[]
}

model Class {
  id        String   @id @default(cuid())
  name      String   @unique // ex: "6Ã¨me A"
  level     String // ex: "6Ã¨me"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teachers      TeacherProfile[] @relation("TeacherClasses")
  students      StudentProfile[]
  assignments   Assignment[]     @relation("ClassAssignments")
  conversations Conversation[]   @relation("ClassConversations")

  // ðŸ†• Phase 7.8 - Ã‰quipes et Assignations
  teams             Team[]
  courseAssignments CourseAssignment[] @relation("ClassCourseAssignments")

  // ðŸ†• Phase 7.11 - Analyses IA
  analyses          ClassAnalysis[]
}

// ============================================
// CONTENUS PÃ‰DAGOGIQUES
// ============================================

model Course {
  id          String  @id @default(cuid())
  title       String
  description String?
  content     String? @db.Text // Contenu markdown/HTML

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id])

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id])

  parentFolderId String?
  parentFolder   Course?  @relation("CourseHierarchy", fields: [parentFolderId], references: [id])
  children       Course[] @relation("CourseHierarchy")

  isFolder Boolean @default(false)
  isDraft  Boolean @default(true) // Brouillon ou publiÃ©

  // MÃ©tadonnÃ©es pÃ©dagogiques
  difficulty Difficulty @default(MEDIUM)
  duration   Int?       // DurÃ©e estimÃ©e en minutes
  objectives String[]   // Objectifs pÃ©dagogiques
  tags       String[]   // Mots-clÃ©s

  // Configuration IA
  aiObjective     String?  @db.Text
  aiExerciseTypes String[] // ["quiz", "application", "case_study", etc.]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  files         CourseFile[]
  exercises     Exercise[]
  assignments   Assignment[]
  progressions  Progression[]
  conversations Conversation[] @relation("CourseConversations")

  // ðŸ†• Phase 7.8 - Structure hiÃ©rarchique
  chapters          Chapter[]
  resources         Resource[]
  courseAssignments CourseAssignment[]

  // ðŸ†• Phase 7bis - Scores agrÃ©gÃ©s
  studentScores     StudentScore[]     @relation("CourseScores")
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

model CourseFile {
  id       String @id @default(cuid())
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  filename String
  fileType String // "pdf", "video", "link", etc.
  url      String
  isLocked Boolean @default(false) // true = imposÃ© par prof

  createdAt DateTime @default(now())
}

model Exercise {
  id      String @id @default(cuid())
  title   String
  type    String // "quiz", "open", "multiple_choice", etc.
  content Json // Structure flexible pour les questions

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  grades Grade[]
}

// ============================================
// ATTRIBUTIONS & PROGRESSION
// ============================================

enum AssignmentTargetType {
  CLASS
  STUDENT
}

enum AssignmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Assignment {
  id String @id @default(cuid())

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  targetType AssignmentTargetType

  // Cible (soit une classe, soit un Ã©lÃ¨ve)
  classId String?
  class   Class?  @relation("ClassAssignments", fields: [classId], references: [id])

  studentId String?

  dueDate DateTime?
  status  AssignmentStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Grade {
  id String @id @default(cuid())

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  score     Float
  maxScore  Float   @default(20)
  aiComment String? @db.Text

  createdAt DateTime @default(now())
}

model Progression {
  id String @id @default(cuid())

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id])

  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  percentage   Float    @default(0)
  lastActivity DateTime @default(now())

  updatedAt DateTime @updatedAt

  @@unique([studentId, courseId])
}

// ============================================
// BLAIZ'BOT LAB (Projets personnels)
// ============================================

enum LabSourceType {
  FILE
  LINK
  YOUTUBE
  TEXT
}

model LabProject {
  id    String @id @default(cuid())
  title String

  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sources LabSource[]
}

model LabSource {
  id String @id @default(cuid())

  projectId String
  project   LabProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  type     LabSourceType
  filename String?
  url      String?
  content  String?       @db.Text

  createdAt DateTime @default(now())
}

// ============================================
// ðŸ†• PHASE 7.8 - CHAPITRES & ORGANISATION
// ============================================

// Types de sections
enum SectionType {
  LESSON     // Contenu texte
  EXERCISE   // Exercice avec correction
  QUIZ       // QCM auto-corrigÃ©
  VIDEO      // VidÃ©o intÃ©grÃ©e
}

// Types de ressources
enum ResourceType {
  LINK       // Lien externe
  YOUTUBE    // VidÃ©o YouTube
  PDF        // Fichier PDF
  DOCUMENT   // Document Word (DOC, DOCX)
  EXCEL      // Tableur Excel (XLS, XLSX)
  POWERPOINT // PrÃ©sentation PowerPoint (PPT, PPTX)
  IMAGE      // Image
}

// Cibles d'assignation
enum CourseAssignmentTarget {
  CLASS      // Toute la classe
  TEAM       // Groupe d'Ã©lÃ¨ves
  STUDENT    // Un Ã©lÃ¨ve
}

// Statuts de progression
enum ProgressStatus {
  NOT_STARTED  // Pas commencÃ©
  IN_PROGRESS  // En cours
  COMPLETED    // TerminÃ©
  GRADED       // NotÃ©
}

// Chapitres (niveau 3 de la hiÃ©rarchie)
model Chapter {
  id          String   @id @default(cuid())
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  title       String
  description String?
  order       Int      @default(0)

  sections    Section[]
  assignments CourseAssignment[] @relation("ChapterAssignments")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
  @@index([order])
}

// Sections (niveau 4 de la hiÃ©rarchie)
model Section {
  id          String      @id @default(cuid())
  chapterId   String
  chapter     Chapter     @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  title       String
  type        SectionType @default(LESSON)
  content     String?     @db.Text  // HTML pour LESSON, JSON pour QUIZ/EXERCISE
  order       Int         @default(0)
  duration    Int?        // Minutes estimÃ©es

  assignments CourseAssignment[] @relation("SectionAssignments")
  progress    StudentProgress[]

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([chapterId])
  @@index([order])
}

// Base de connaissances du cours (ressources)
model Resource {
  id          String       @id @default(cuid())
  courseId    String
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  title       String
  description String?
  type        ResourceType
  url         String?      // Pour LINK, YOUTUBE
  fileUrl     String?      // Pour PDF, IMAGE (upload)
  order       Int          @default(0)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([courseId])
  @@index([type])
}

// Ã‰quipes (groupes d'Ã©lÃ¨ves dans une classe)
model Team {
  id          String       @id @default(cuid())
  name        String
  classId     String
  class       Class        @relation(fields: [classId], references: [id], onDelete: Cascade)

  members     TeamMember[]
  assignments CourseAssignment[] @relation("TeamAssignments")

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([classId])
}

// Membres d'une Ã©quipe
model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  studentId String
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([teamId, studentId])
}

// Assignations de cours/chapitres/sections
model CourseAssignment {
  id          String               @id @default(cuid())

  // Qui assigne
  teacherId   String
  teacher     User                 @relation("TeacherCourseAssignments", fields: [teacherId], references: [id])

  // Quoi assigner (un seul parmi les 3)
  courseId    String?
  course      Course?              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapterId   String?
  chapter     Chapter?             @relation("ChapterAssignments", fields: [chapterId], references: [id], onDelete: Cascade)
  sectionId   String?
  section     Section?             @relation("SectionAssignments", fields: [sectionId], references: [id], onDelete: Cascade)

  // Ã€ qui assigner
  targetType  CourseAssignmentTarget
  classId     String?
  class       Class?               @relation("ClassCourseAssignments", fields: [classId], references: [id], onDelete: Cascade)
  teamId      String?
  team        Team?                @relation("TeamAssignments", fields: [teamId], references: [id], onDelete: Cascade)
  studentId   String?
  student     User?                @relation("StudentCourseAssignments", fields: [studentId], references: [id])

  // DÃ©tails
  title       String
  instructions String?             @db.Text
  dueDate     DateTime?

  // Suivi
  progress    StudentProgress[]

  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@index([teacherId])
  @@index([courseId])
  @@index([chapterId])
  @@index([sectionId])
  @@index([classId])
  @@index([teamId])
  @@index([studentId])
}

// Progression d'un Ã©lÃ¨ve sur une assignation
model StudentProgress {
  id           String         @id @default(cuid())

  assignmentId String
  assignment   CourseAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  studentId    String
  student      User           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Lien direct vers la section (optionnel)
  sectionId    String?
  section      Section?       @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  status       ProgressStatus @default(NOT_STARTED)
  score        Float?         // Note sur 100
  timeSpent    Int?           // Minutes passÃ©es
  completedAt  DateTime?

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([assignmentId, studentId])
  @@index([studentId])
  @@index([sectionId])
}

// ðŸ†• Phase 7bis - Score agrÃ©gÃ© par Ã©lÃ¨ve et par cours
model StudentScore {
  id          String   @id @default(cuid())

  studentId   String
  student     User     @relation("StudentScores", fields: [studentId], references: [id], onDelete: Cascade)

  courseId    String
  course      Course   @relation("CourseScores", fields: [courseId], references: [id], onDelete: Cascade)

  // Scores IA automatiques (0-100)
  quizAvg         Float    @default(0)
  exerciseAvg     Float    @default(0)
  aiComprehension Float    @default(0)
  continuousScore Float    @default(0)  // CalculÃ©: Quiz*35% + Exo*40% + IA*25%

  // Compteurs
  quizCount       Int      @default(0)
  exerciseCount   Int      @default(0)
  aiSessionCount  Int      @default(0)

  // Examen Final (note prof sur 6 - systÃ¨me suisse)
  examGrade       Float?              // Note sur 6
  examDate        DateTime?
  examComment     String?

  // Score Final calculÃ©
  finalScore      Float?              // 0-100: Continu*40% + Exam*60%
  finalGrade      Float?              // Note sur 6

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
}

// ============================================
// BASE DE CONNAISSANCES
// ============================================

enum KnowledgeOwnerType {
  TEACHER
  STUDENT
}

model KnowledgeBase {
  id String @id @default(cuid())

  ownerType KnowledgeOwnerType

  // PropriÃ©taire (soit prof via subject, soit Ã©lÃ¨ve)
  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id])

  studentId String?
  student   StudentProfile? @relation("StudentKnowledge", fields: [studentId], references: [id])

  topic     String
  documents Json // Array de {filename, url, type}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// MESSAGERIE
// ============================================

enum ConversationType {
  CLASS_GENERAL
  CLASS_TOPIC
  PRIVATE
}

model Conversation {
  id   String           @id @default(cuid())
  type ConversationType

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id])

  // ðŸ†• RÃ©fÃ©rence optionnelle au cours
  courseId String?
  course   Course? @relation("CourseConversations", fields: [courseId], references: [id])

  // ðŸ†• RÃ©fÃ©rence optionnelle Ã  la classe (pour messages de classe)
  classId String?
  class   Class? @relation("ClassConversations", fields: [classId], references: [id])

  topicName String? // ex: "Les Fractions"

  // Participants (stockÃ© comme array d'IDs pour flexibilitÃ©)
  participantIds String[]

  // ðŸ†• AnnÃ©e scolaire pour historique
  schoolYear String @default("2024-2025")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages Message[]
}

model Message {
  id String @id @default(cuid())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation("SentMessages", fields: [senderId], references: [id])

  content     String @db.Text
  attachments Json? // Array de {filename, url}

  createdAt DateTime @default(now())

  // ðŸ†• Statut de lecture par participant
  readStatus MessageReadStatus[]
}

// ðŸ†• Tracking lu/non-lu par participant
model MessageReadStatus {
  id        String    @id @default(cuid())
  messageId String
  message   Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  readAt    DateTime?

  @@unique([messageId, userId])
}

// ðŸ†• Notifications
enum NotificationType {
  MESSAGE
  ASSIGNMENT
  GRADE
  SYSTEM
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String
  message   String
  link      String?          // URL vers la ressource

  read      Boolean          @default(false)

  createdAt DateTime         @default(now())
}

// ============================================
// CALENDRIER
// ============================================

model CalendarEvent {
  id String @id @default(cuid())

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  title       String
  description String? @db.Text

  startDate DateTime
  endDate   DateTime

  isTeacherEvent Boolean @default(false) // true = Ã©vÃ©nement imposÃ© par prof

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// CONFIGURATION IA
// ============================================

enum AIProvider {
  OPENAI
  GOOGLE
  ANTHROPIC
  MISTRAL
  CUSTOM
}

enum AIRestrictionLevel {
  STRICT
  BALANCED
  CREATIVE
}

model AISettings {
  id String @id @default(cuid())

  provider AIProvider @default(OPENAI)
  apiKey   String // ChiffrÃ© en BDD
  model    String     @default("gpt-4o")
  endpoint String? // Pour CUSTOM

  restrictionLevel    AIRestrictionLevel @default(BALANCED)
  enablePdfAnalysis   Boolean            @default(true)
  allowTeacherPrompts Boolean            @default(true)
  maintenanceMode     Boolean            @default(false)

  platformName    String @default("Blaiz'bot")
  defaultLanguage String @default("fr")

  updatedAt DateTime @updatedAt
}

model AIChat {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  contextType String // "course", "lab", "assistant"
  contextId   String? // ID du cours ou projet

  messages Json // Array de {role, content, timestamp}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// ANALYTICS & IA (Phase 7.11)
// ============================================

model ClassAnalysis {
  id          String   @id @default(cuid())
  classId     String
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  // Contexte utilisï¿½
  resourceIds String[] // IDs des ressources analysï¿½es (Vidï¿½os, PDFs)
  
  // Contenu gï¿½nï¿½rï¿½
  summary     String   @db.Text
  strengths   String[]
  weaknesses  String[]
  actions     String[]
  
  createdAt   DateTime @default(now())
  
  @@index([classId])
}

