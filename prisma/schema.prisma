generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AIActivityScore {
  id                 String       @id
  studentId          String
  courseId           String
  aiChatId           String       @unique
  activityType       ActivityType
  activityId         String?
  themeId            String?
  comprehensionScore Float
  accuracyScore      Float
  autonomyScore      Float
  finalScore         Float
  duration           Int
  messageCount       Int
  aiPromptTokens     Int
  strengths          String?
  weaknesses         String?
  recommendation     String?
  createdAt          DateTime     @default(now())
  AIChat             AIChat       @relation(fields: [aiChatId], references: [id], onDelete: Cascade)
  Course             Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  User               User         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([activityType])
  @@index([aiChatId])
  @@index([studentId, courseId])
}

model AIChat {
  id              String           @id
  userId          String
  contextType     String
  contextId       String?
  messages        Json
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  AIActivityScore AIActivityScore?
  User            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AISettings {
  id                  String             @id
  provider            AIProvider         @default(OPENAI)
  apiKey              String
  model               String             @default("gpt-4o")
  endpoint            String?
  restrictionLevel    AIRestrictionLevel @default(BALANCED)
  enablePdfAnalysis   Boolean            @default(true)
  allowTeacherPrompts Boolean            @default(true)
  maintenanceMode     Boolean            @default(false)
  platformName        String             @default("Blaiz'bot")
  defaultLanguage     String             @default("fr")
  updatedAt           DateTime
}

model Assignment {
  id         String               @id
  courseId   String
  targetType AssignmentTargetType
  classId    String?
  studentId  String?
  dueDate    DateTime?
  status     AssignmentStatus     @default(ACTIVE)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime
  Class      Class?               @relation(fields: [classId], references: [id])
  Course     Course               @relation(fields: [courseId], references: [id])
}

model CalendarEvent {
  id             String   @id
  ownerId        String
  title          String
  description    String?
  startDate      DateTime
  endDate        DateTime
  isTeacherEvent Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  User           User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model Chapter {
  id               String             @id
  courseId         String
  title            String
  description      String?
  order            Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  Course           Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  CourseAssignment CourseAssignment[]
  Section          Section[]

  @@index([courseId])
  @@index([order])
}

model Class {
  id               String             @id
  name             String             @unique
  level            String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  Assignment       Assignment[]
  ClassAnalysis    ClassAnalysis[]
  Conversation     Conversation[]
  CourseAssignment CourseAssignment[]
  StudentProfile   StudentProfile[]
  Team             Team[]
  TeacherProfile   TeacherProfile[]   @relation("TeacherClasses")
}

model ClassAnalysis {
  id          String   @id
  classId     String
  resourceIds String[]
  summary     String
  strengths   String[]
  weaknesses  String[]
  actions     String[]
  createdAt   DateTime @default(now())
  Class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([classId])
}

model Conversation {
  id             String           @id
  type           ConversationType
  subjectId      String?
  topicName      String?
  participantIds String[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  classId        String?
  courseId       String?
  schoolYear     String           @default("2024-2025")
  Class          Class?           @relation(fields: [classId], references: [id])
  Course         Course?          @relation(fields: [courseId], references: [id])
  Subject        Subject?         @relation(fields: [subjectId], references: [id])
  Message        Message[]
}

model Course {
  id               String             @id
  title            String
  description      String?
  content          String?
  subjectId        String
  teacherId        String
  parentFolderId   String?
  isFolder         Boolean            @default(false)
  isDraft          Boolean            @default(true)
  difficulty       Difficulty         @default(MEDIUM)
  duration         Int?
  objectives       String[]
  tags             String[]
  aiObjective      String?
  aiExerciseTypes  String[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  AIActivityScore  AIActivityScore[]
  Assignment       Assignment[]
  Chapter          Chapter[]
  Conversation     Conversation[]
  Course           Course?            @relation("CourseToCourse", fields: [parentFolderId], references: [id])
  other_Course     Course[]           @relation("CourseToCourse")
  Subject          Subject            @relation(fields: [subjectId], references: [id])
  TeacherProfile   TeacherProfile     @relation(fields: [teacherId], references: [id])
  CourseAssignment CourseAssignment[]
  CourseFile       CourseFile[]
  Exercise         Exercise[]
  Progression      Progression[]
  Resource         Resource[]
  StudentScore     StudentScore[]
}

model CourseAssignment {
  id                                    String                 @id
  teacherId                             String
  courseId                              String?
  chapterId                             String?
  sectionId                             String?
  targetType                            CourseAssignmentTarget
  classId                               String?
  teamId                                String?
  studentId                             String?
  title                                 String
  instructions                          String?
  dueDate                               DateTime?
  createdAt                             DateTime               @default(now())
  updatedAt                             DateTime
  Chapter                               Chapter?               @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  Class                                 Class?                 @relation(fields: [classId], references: [id], onDelete: Cascade)
  Course                                Course?                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Section                               Section?               @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  User_CourseAssignment_studentIdToUser User?                  @relation("CourseAssignment_studentIdToUser", fields: [studentId], references: [id])
  User_CourseAssignment_teacherIdToUser User                   @relation("CourseAssignment_teacherIdToUser", fields: [teacherId], references: [id])
  Team                                  Team?                  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  StudentProgress                       StudentProgress[]

  @@index([chapterId])
  @@index([classId])
  @@index([courseId])
  @@index([sectionId])
  @@index([studentId])
  @@index([teacherId])
  @@index([teamId])
}

model CourseFile {
  id        String   @id
  courseId  String
  filename  String
  fileType  String
  url       String
  isLocked  Boolean  @default(false)
  createdAt DateTime @default(now())
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Exercise {
  id        String   @id
  title     String
  type      String
  content   Json
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Grade     Grade[]
}

model Grade {
  id             String         @id
  studentId      String
  exerciseId     String
  score          Float
  maxScore       Float          @default(20)
  aiComment      String?
  createdAt      DateTime       @default(now())
  Exercise       Exercise       @relation(fields: [exerciseId], references: [id])
  StudentProfile StudentProfile @relation(fields: [studentId], references: [id])
}

model KnowledgeBase {
  id             String             @id
  ownerType      KnowledgeOwnerType
  subjectId      String?
  studentId      String?
  topic          String
  documents      Json
  createdAt      DateTime           @default(now())
  updatedAt      DateTime
  StudentProfile StudentProfile?    @relation(fields: [studentId], references: [id])
  Subject        Subject?           @relation(fields: [subjectId], references: [id])
}

model LabProject {
  id             String         @id
  title          String
  studentId      String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  StudentProfile StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  LabSource      LabSource[]
}

model LabSource {
  id         String        @id
  projectId  String
  type       LabSourceType
  filename   String?
  url        String?
  content    String?
  createdAt  DateTime      @default(now())
  LabProject LabProject    @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Message {
  id                String              @id
  conversationId    String
  senderId          String
  content           String
  attachments       Json?
  createdAt         DateTime            @default(now())
  Conversation      Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User              User                @relation(fields: [senderId], references: [id])
  MessageReadStatus MessageReadStatus[]
}

model MessageReadStatus {
  id        String    @id
  messageId String
  userId    String
  readAt    DateTime?
  Message   Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
}

model Notification {
  id        String           @id
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Progression {
  id             String         @id
  studentId      String
  courseId       String
  percentage     Float          @default(0)
  lastActivity   DateTime       @default(now())
  updatedAt      DateTime
  Course         Course         @relation(fields: [courseId], references: [id])
  StudentProfile StudentProfile @relation(fields: [studentId], references: [id])

  @@unique([studentId, courseId])
}

model Resource {
  id          String       @id
  courseId    String
  title       String
  description String?
  type        ResourceType
  url         String?
  fileUrl     String?
  order       Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  Course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([type])
}

model Section {
  id               String             @id
  chapterId        String
  title            String
  type             SectionType        @default(LESSON)
  content          String?
  order            Int                @default(0)
  duration         Int?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  CourseAssignment CourseAssignment[]
  Chapter          Chapter            @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  StudentProgress  StudentProgress[]
  files            SectionFile[]

  @@index([chapterId])
  @@index([order])
}

// Fichiers de base de connaissance liés à une section
model SectionFile {
  id        String   @id @default(cuid())
  sectionId String
  filename  String
  fileType  String
  url       String
  size      Int?
  createdAt DateTime @default(now())
  Section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@index([sectionId])
}

model StudentProfile {
  id            String          @id
  userId        String          @unique
  classId       String
  parentEmail   String?
  Grade         Grade[]
  KnowledgeBase KnowledgeBase[]
  LabProject    LabProject[]
  Progression   Progression[]
  Class         Class           @relation(fields: [classId], references: [id])
  User          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  Subject       Subject[]       @relation("StudentSubjects")
}

model StudentProgress {
  id               String           @id
  assignmentId     String
  studentId        String
  sectionId        String?
  status           ProgressStatus   @default(NOT_STARTED)
  score            Float?
  timeSpent        Int?
  completedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime
  CourseAssignment CourseAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  Section          Section?         @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  User             User             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
  @@index([sectionId])
  @@index([studentId])
}

model StudentScore {
  id              String    @id
  studentId       String
  courseId        String
  quizAvg         Float     @default(0)
  exerciseAvg     Float     @default(0)
  aiComprehension Float     @default(0)
  continuousScore Float     @default(0)
  quizCount       Int       @default(0)
  exerciseCount   Int       @default(0)
  aiSessionCount  Int       @default(0)
  examGrade       Float?
  examDate        DateTime?
  examComment     String?
  finalScore      Float?
  finalGrade      Float?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  Course          Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  User            User      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([courseId])
  @@index([studentId])
}

model Subject {
  id             String           @id
  name           String           @unique
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  Conversation   Conversation[]
  Course         Course[]
  KnowledgeBase  KnowledgeBase[]
  StudentProfile StudentProfile[] @relation("StudentSubjects")
  TeacherProfile TeacherProfile[] @relation("TeacherSubjects")
}

model TeacherProfile {
  id      String    @id
  userId  String    @unique
  Course  Course[]
  User    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  Class   Class[]   @relation("TeacherClasses")
  Subject Subject[] @relation("TeacherSubjects")
}

model Team {
  id               String             @id
  name             String
  classId          String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  CourseAssignment CourseAssignment[]
  Class            Class              @relation(fields: [classId], references: [id], onDelete: Cascade)
  TeamMember       TeamMember[]

  @@index([classId])
}

model TeamMember {
  id        String   @id
  teamId    String
  studentId String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  Team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, studentId])
}

model User {
  id                                                String              @id
  email                                             String              @unique
  passwordHash                                      String
  role                                              Role
  firstName                                         String
  lastName                                          String
  phone                                             String?
  address                                           String?
  city                                              String?
  postalCode                                        String?
  isActive                                          Boolean             @default(true)
  lastLogin                                         DateTime?
  createdAt                                         DateTime            @default(now())
  updatedAt                                         DateTime
  AIActivityScore                                   AIActivityScore[]
  AIChat                                            AIChat[]
  CalendarEvent                                     CalendarEvent[]
  CourseAssignment_CourseAssignment_studentIdToUser CourseAssignment[]  @relation("CourseAssignment_studentIdToUser")
  CourseAssignment_CourseAssignment_teacherIdToUser CourseAssignment[]  @relation("CourseAssignment_teacherIdToUser")
  Message                                           Message[]
  MessageReadStatus                                 MessageReadStatus[]
  Notification                                      Notification[]
  StudentProfile                                    StudentProfile?
  StudentProgress                                   StudentProgress[]
  StudentScore                                      StudentScore[]
  TeacherProfile                                    TeacherProfile?
  TeamMember                                        TeamMember[]
}

enum AIProvider {
  OPENAI
  GOOGLE
  ANTHROPIC
  MISTRAL
  CUSTOM
}

enum AIRestrictionLevel {
  STRICT
  BALANCED
  CREATIVE
}

enum ActivityType {
  QUIZ
  EXERCISE
  REVISION
}

enum AssignmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum AssignmentTargetType {
  CLASS
  STUDENT
}

enum ConversationType {
  CLASS_GENERAL
  CLASS_TOPIC
  PRIVATE
}

enum CourseAssignmentTarget {
  CLASS
  TEAM
  STUDENT
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum KnowledgeOwnerType {
  TEACHER
  STUDENT
}

enum LabSourceType {
  FILE
  LINK
  YOUTUBE
  TEXT
}

enum NotificationType {
  MESSAGE
  ASSIGNMENT
  GRADE
  SYSTEM
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  GRADED
}

enum ResourceType {
  LINK
  YOUTUBE
  PDF
  IMAGE
  DOCUMENT
  EXCEL
  POWERPOINT
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum SectionType {
  LESSON
  EXERCISE
  QUIZ
  VIDEO
}
